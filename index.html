import React, { useState } from 'react';

const PreferenceQuiz = () => {
  const questions = [
    { question: "I'd rather park at a paid parking lot immediately than spend 10+ minutes searching for free parking.", tag: "(Transportation)", category: "Convenience" },
    { question: "I'm willing to drive 30 minutes to an outlet to save 20% on groceries instead of shopping at a nearby supermarket.", tag: "(Groceries)", category: "Cost" },
    { question: "I often forget to cancel free trials before they auto-renew and get charged.", tag: "(Subscription)", category: "Convenience" },
    { question: "I add unnecessary items to my cart to meet minimum order requirements and avoid delivery fees.", tag: "(Shopping)", category: "Cost" },
    { question: "When buying a product, one negative review worries me more than 100 positive reviews.", tag: "(Reviews)", category: "Safety" },
    { question: "I feel more comfortable following proven methods rather than pioneering something no one has tried.", tag: "(New Things)", category: "Safety" },
    { question: "Even when a deadline is approaching, I keep working until the last minute to fix unsatisfactory parts.", tag: "(Perfection)", category: "Emotion" },
    { question: "When planning trips, I always ensure there's 'buffer time' without detailed schedules.", tag: "(Planning)", category: "Emotion" },
    { question: "I don't hesitate to pay extra for faster delivery (e.g., $3) when ordering online.", tag: "(Orders)", category: "Time" },
    { question: "I prefer paying professionals to fix things immediately rather than learning to assemble furniture or do simple repairs myself.", tag: "(DIY)", category: "Convenience" },
    { question: "I'd rather pay a small fee for an organized report than navigate through multiple webpages to find information.", tag: "(Information)", category: "Convenience" },
    { question: "If finding and applying coupons takes more than 5 minutes, I just pay full price.", tag: "(Discounts)", category: "Convenience" },
    { question: "Before trying a completely new restaurant or hobby, I read at least 3 detailed reviews first.", tag: "(New Experiences)", category: "Safety" },
    { question: "Even when nothing is wrong, I never skip regular maintenance checkups for machines or vehicles.", tag: "(Maintenance)", category: "Safety" },
    { question: "Before submitting projects or work, I keep extending review time due to perfectionism even when I have time.", tag: "(Perfection)", category: "Emotion" },
    { question: "When planning trips or major events, I always prepare a backup 'Plan B' in case things go wrong.", tag: "(Planning)", category: "Safety" },
    { question: "I actively select 'no disposable items' on delivery apps to reduce packaging waste.", tag: "(Orders)", category: "Sustainability" },
    { question: "In group chats, I consider others' reactions and feelings first and edit my messages before sending.", tag: "(Communication)", category: "Community" },
    { question: "When choosing gifts, I prioritize the recipient's personal feelings and what would truly make them happy.", tag: "(Gifts)", category: "Emotion" },
    { question: "In public places or shared offices, I'm mindful that my belongings don't inconvenience others.", tag: "(Space)", category: "Community" },
    { question: "When disposing of broken or unwanted items, I make extra effort to follow proper recycling regulations.", tag: "(Products)", category: "Sustainability" }
  ];

  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [answers, setAnswers] = useState([]);
  const [isComplete, setIsComplete] = useState(false);

  const handleAnswer = (score) => {
    const newAnswers = [...answers, { score, category: questions[currentQuestion].category }];
    setAnswers(newAnswers);

    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    } else {
      setIsComplete(true);
      sendDataToSheet(newAnswers);
    }
  };

  const sendDataToSheet = async (finalAnswers) => {
    const data = {
      answers: finalAnswers,
      timestamp: new Date().toISOString()
    };

    try {
      fetch('https://script.google.com/macros/s/AKfycbwW5xN8Yi_hQT2IapUDxC6Bb0AKaUdt9-_Kn33RCh5qV_jY5pYrq0859rT80YYQQHMD/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });
    } catch (error) {
      console.error('Error sending data:', error);
    }
  };

  const restartQuiz = () => {
    setCurrentQuestion(0);
    setAnswers([]);
    setIsComplete(false);
  };

  const calculateCategoryScores = () => {
    const categoryScores = {};
    const categoryCounts = {};

    answers.forEach(answer => {
      if (!categoryScores[answer.category]) {
        categoryScores[answer.category] = 0;
        categoryCounts[answer.category] = 0;
      }
      categoryScores[answer.category] += answer.score;
      categoryCounts[answer.category] += 1;
    });

    const categoryPercentages = {};
    const totalPossible = Object.keys(categoryCounts).reduce((sum, cat) => sum + (categoryCounts[cat] * 5), 0);

    Object.keys(categoryScores).forEach(category => {
      const maxScore = categoryCounts[category] * 5;
      categoryPercentages[category] = {
        score: categoryScores[category],
        maxScore: maxScore,
        percentage: (categoryScores[category] / maxScore * 100).toFixed(1),
        count: categoryCounts[category]
      };
    });

    return categoryPercentages;
  };

  const getTopCategory = (categoryPercentages) => {
    let topCategory = '';
    let highestPercentage = 0;

    Object.keys(categoryPercentages).forEach(category => {
      const percentage = parseFloat(categoryPercentages[category].percentage);
      if (percentage > highestPercentage) {
        highestPercentage = percentage;
        topCategory = category;
      }
    });

    return topCategory;
  };

  if (isComplete) {
    const categoryPercentages = calculateCategoryScores();
    const topCategory = getTopCategory(categoryPercentages);
    
    const categoryColors = {
      'Convenience': 'bg-blue-500',
      'Cost': 'bg-green-500',
      'Safety': 'bg-yellow-500',
      'Emotion': 'bg-purple-500',
      'Time': 'bg-red-500',
      'Sustainability': 'bg-teal-500',
      'Community': 'bg-pink-500'
    };

    return (
      <div className="min-h-screen bg-black flex items-center justify-center p-4" style={{ fontFamily: "'Suisse Intl', sans-serif" }}>
        <style>{`
          @import url('https://fonts.cdnfonts.com/css/suisse-intl');
        `}</style>
        <div className="bg-white border border-gray-300 rounded-lg p-8 max-w-4xl w-full">
          <div className="text-center mb-12">
            <p className="text-gray-600 mb-2">Your Value Type is</p>
            <h1 className="text-5xl font-bold text-gray-900 mb-4">{topCategory}</h1>
            <p className="text-gray-600">This is your highest category</p>
          </div>

          <div className="mb-10">
            <h2 className="text-xl font-bold text-gray-900 mb-6">Category Analysis</h2>
            <div className="space-y-6">
              {Object.keys(categoryPercentages).sort((a, b) => 
                parseFloat(categoryPercentages[b].percentage) - parseFloat(categoryPercentages[a].percentage)
              ).map((category) => {
                const data = categoryPercentages[category];
                return (
                  <div key={category} className="space-y-2">
                    <div className="flex justify-between items-center">
                      <div className="flex items-center gap-3">
                        <span className="font-bold text-gray-900 text-lg">{category}</span>
                        <span className="text-sm text-gray-500">({data.count} questions)</span>
                      </div>
                      <div className="text-right">
                        <span className="text-2xl font-bold text-gray-900">{data.percentage}%</span>
                        <span className="text-sm text-gray-500 ml-2">({data.score}/{data.maxScore} points)</span>
                      </div>
                    </div>
                    <div className="w-full bg-gray-200 h-8 rounded-full overflow-hidden">
                      <div
                        className={`${categoryColors[category]} h-full rounded-full transition-all duration-1000 ease-out flex items-center justify-end pr-3`}
                        style={{ width: `${data.percentage}%` }}
                      >
                        <span className="text-white font-semibold text-sm">{data.percentage}%</span>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          <div className="mb-8">
            <h2 className="text-xl font-bold text-gray-900 mb-4">Detailed Responses</h2>
            <div className="space-y-3 max-h-96 overflow-y-auto">
              {questions.map((q, index) => (
                <div key={index} className="bg-gray-50 border border-gray-200 rounded p-4">
                  <div className="flex justify-between items-start mb-2">
                    <p className="font-medium text-gray-900 text-sm flex-1">
                      <span className="text-gray-500">{q.tag}</span> Q{index + 1}: {q.question}
                    </p>
                    <span className={`ml-3 px-3 py-1 rounded-full text-xs font-semibold text-white ${categoryColors[q.category]}`}>
                      {q.category}
                    </span>
                  </div>
                  <p className="text-gray-600 text-sm">
                    Response: <span className="font-bold text-gray-900">{answers[index].score} points</span>
                  </p>
                </div>
              ))}
            </div>
          </div>

          <button
            onClick={restartQuiz}
            className="w-full bg-gray-900 text-white font-semibold py-3 px-6 rounded hover:bg-gray-800 transition-all"
          >
            Restart Quiz
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-black flex items-center justify-center p-4" style={{ fontFamily: "'Suisse Intl', sans-serif" }}>
      <style>{`
        @import url('https://fonts.cdnfonts.com/css/suisse-intl');
      `}</style>
      <div className="bg-white border border-gray-300 rounded-lg p-8 max-w-2xl w-full">
        <div className="mb-6">
          <div className="flex justify-between items-center mb-2">
            <span className="text-sm font-semibold text-gray-600">
              Question {currentQuestion + 1} / {questions.length}
            </span>
            <span className="text-xs text-gray-500">
              Questions (5-point scale: higher score = more agreement)
            </span>
          </div>
          <div className="w-full bg-gray-200 h-1 rounded">
            <div
              className="bg-gray-900 h-1 rounded transition-all duration-300"
              style={{ width: `${((currentQuestion + 1) / questions.length) * 100}%` }}
            />
          </div>
        </div>

        <h2 className="text-xl font-medium text-gray-900 mb-8 leading-relaxed">
          {questions[currentQuestion].question}
        </h2>

        <div className="grid grid-cols-5 gap-3">
          {[1, 2, 3, 4, 5].map((score) => (
            <button
              key={score}
              onClick={() => handleAnswer(score)}
              className="bg-white hover:bg-gray-900 text-gray-900 hover:text-white font-semibold py-6 px-4 rounded transition-all border-2 border-gray-900 transform hover:scale-105"
            >
              {score}
            </button>
          ))}
        </div>
        
        <div className="flex justify-between mt-4 text-xs text-gray-500 px-1">
          <span>Strongly Disagree</span>
          <span>Strongly Agree</span>
        </div>
      </div>
    </div>
  );
};

export default PreferenceQuiz;
